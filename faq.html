<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
<head>
    <title>Linux 802.11n CSI Tool &mdash; FAQ and Things to Know</title>
    <link rel="stylesheet" href="css/dan.css"/>
</head>
<body width=600>

<H1>Linux 802.11n CSI Tool</H1>
<H2>FAQ &amp; Things to Know</H2>


<!--- ********************************************************************* -->
<H3>1. Setting wireless bitrates (and getting/setting more station information)</H3>

<H4>Station information in <tt>debugfs</tt></H4>

<p>When the NIC connects to another 802.11 device (when it's a client, the AP; when it's an AP, the clients), it creates an entry for that device in <tt>debugfs</tt>.  To see the list of these other stations, run the following command. Note that <tt>phy0</tt> may have a different number on your machine depending on what other wireless devices have been installed.</p>

<pre>
% ls /sys/kernel/debug/ieee80211/phy0/stations
00:0f:34:9d:01:a0
</pre>

<p>Here, you can see a list of all the MAC addresses this machine knows. My machine is in client node, so I will only see the MAC address for the AP. Inside that directory is a wide variety of useful info. I'll leave it up to the reader to explore. For now, let's focus on the <tt>rate_scale_table</tt> entry.</p>

<pre>
% sudo cat /sys/kernel/debug/ieee80211/phy0/stations/00:0f:34:9d:01:a0/rate_scale_table  
sta_id 0
failed=0 success=0 rate=0FFF
fixed rate 0x0
valid_tx_ant ANT_A,ANT_B,ANT_C
lq type legacy
last tx rate=0x420A
general:flags=0x0 mimo-d=0 s-ant0x1 d-ant=0x3
agg:time_limit=4000 dist_start_th=3 frame_cnt_limit=31
Start idx [0]=0x0 [1]=0x0 [2]=0x0 [3]=0x0
 rate[0] 0x420A 1mbps
 rate[1] 0x420A 1mbps
 rate[2] 0x420A 1mbps
 ...
</pre>

<p>This gives us access to some basic information about the configuration of this client and that AP. For instance, we can see that all three transmit antennas are valid (<tt>valid_tx_ant ANT_A,ANT_B,ANT_C</tt>). We can see that this is not an 802.11n AP (<tt>lq type legacy</tt> &mdash; an 802.11n AP would say <tt>lq type HT</tt>). The last packet transmitted to this station was transmitted with rate <tt>0x420A</tt>, and we see below that that the rate used for all 16 transmit attempts is this same <tt>0x420A</tt>.<p>

<H4>How rates are represented</H4>

<p>Let's talk about this value <tt>0x420A</tt>. This value is usually stored in a variable that the driver calls <tt>rate_n_flags</tt>; it is a 32-bit unsigned integer and can be decomposed by looking at the <tt>RATE_MCS_</tt> flags and masks defined in <tt>iwl-commands.h</tt>. Here is a snippet:</p>

<pre>
/**
 * iwlagn rate_n_flags bit fields
 *
 * rate_n_flags format is used in following iwlagn commands:
 *  REPLY_RX (response only)
 *  REPLY_RX_MPDU (response only)
 *  REPLY_TX (both command and response)
 *  REPLY_TX_LINK_QUALITY_CMD
 *
 * High-throughput (HT) rate format for bits 7:0 (bit 8 must be "1"):
 *  2-0:  0)   6 Mbps
 *        1)  12 Mbps
 *        2)  18 Mbps
 *        3)  24 Mbps
 *        4)  36 Mbps
 *        5)  48 Mbps
 *        6)  54 Mbps
 *        7)  60 Mbps
 *
 *  4-3:  0)  Single stream (SISO)
 *        1)  Dual stream (MIMO)
 *        2)  Triple stream (MIMO)
 *
 *    5:  Value of 0x20 in bits 7:0 indicates 6 Mbps HT40 duplicate data
 *
 * Legacy OFDM rate format for bits 7:0 (bit 8 must be "0", bit 9 "0"):
 *  3-0:  0xD)   6 Mbps
 *        0xF)   9 Mbps
 *        0x5)  12 Mbps
 *        0x7)  18 Mbps
 *        0x9)  24 Mbps
 *        0xB)  36 Mbps
 *        0x1)  48 Mbps
 *        0x3)  54 Mbps
 *
 * Legacy CCK rate format for bits 7:0 (bit 8 must be "0", bit 9 "1"):
 *  6-0:   10)  1 Mbps
 *         20)  2 Mbps
 *         55)  5.5 Mbps
 *        110)  11 Mbps
 */
</pre>

<p>Parsing these takes some getting used to, but soon you'll be reading rates trivially. I'll tell you now that this packet was sent on Antenna A (the <tt>0x4000</tt>). The packet was sent with one of the 802.11b CCK modulations (bit 8 is "0", bit "9" is 1, <tt>0x200</tt>). Finally, the packet was sent at 1 Mbps &mdash; the low order 6 bits are <tt>0xA</tt> which equal 10.</p>

<p>Breaking this down, we have:</p>

<pre>
0x420A =
           0x4000        (RATE_MCS_ANT_A_MSK = 0x4000)
         | 0x0200        (RATE_MCS_CCK_MSK = 0x200)
         | 0x000A        (10  &lt;&ndash;&gt;  1 Mbps)
</pre> 

<p>For 802.11n (also called HT) rates, the rate_n_flags might look like this:</p>

<pre>
0x1c113 =
            0x1c000      (RATE_MCS_ANT_ABC_MSK &mdash; all 3 antennas)
          | 0x00100      (RATE_MCS_HT_MSK &mdash; this is an HT rate)
          | 0x00010      (2 &lt;&lt; RATE_MCS_SPATIAL_POS means 3 spatial streams)
          | 0x00003      (3 corresponds to the 16QAM-1/2, 26 Mbps modulation)
</pre>

<p>This is a MIMO packet using all 3 transmit antennas and 3 spatial streams, and it corresponds to the 3x26 Mbps rate that gives 78 Mbps in total.  Another way to think about the lower 8 bits of an HT rate is as the MCS (Modulation and Coding Scheme). See Tables 20-29 through 20-43 in the IEEE 802.11n standard for more information. Note that, currently, Intel's NICs only support equal modulation with 3 or fewer streams, that is, MCS 0&ndash;23 and also MCS 32.</p>

<H4>Setting the transmit bitrate</H4>

<p>Intel has included a debug mode where you can set the transmit rate for a particular receiver. It sets all 16 attempts, in the case of a lossy link, to the same rate. Simply write the rate you wish to use into that same file.<p>

<pre>
% sudo -s
# echo 0x4214 &gt; /sys/kernel/debug/<b>...</b>/rate_scale_table  
</pre>

<p>This should set the AP to use the 2 Mbps rate instead, since <tt>0x14</tt> equals 20.</p>

<p>Note that you have to escalate to a <tt>root</tt> shell to write that file; <tt>sudo echo 0x4214 &gt; /sys/<i>blah</i></tt> won't work because only the echo is run as <tt>root</tt>. You can get around this by using the <tt>tee</tt> program. [<a href="http://ubuntuforums.org/showthread.php?t=412329">hat tip</a>]</p>

<pre>
% echo 0x4214 | sudo tee -a /sys/kernel/debug/<b>...</b>/rate_scale_table
</pre>

<p>Of course, if you write an illegal value to this entry, the firmware will likely crash and the driver may simply stop working. Check the kernel log via <tt>dmesg</tt> if you suspect this may be happening.</tt> Here is an example of an illegal write:</p>

<pre>
% echo <font color="red"><b>0x14107</b></font> | sudo tee -a /sys/kernel/debug/<b>...</b>/rate_scale_table
</pre>

<p>Here I've told the NIC to use two antennas, A and C, but have only given it a single-stream MCS. This is of course an illegal selection; I can use Antenna A or Antenna C, but not both!</p>

<!--- ********************************************************************* -->
    <script type="text/javascript">
        var gaJsHost = (("https:" == document.location.protocol) ?
        "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost +
        "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
        var pageTracker = _gat._getTracker("UA-3907502-1");
        pageTracker._initData();
        pageTracker._trackPageview();
    </script>
</body>
</html>
